<plugin>
	<div class="mobile-header">Sun Details</div>

	<div class="plugin-content">
		<div class="open-picker">
			<h2>Picker not open</h2>
			Please open the weather picker to define position for sun-details.
		</div>
		<div class="sun-times" id="hide">
			<div class="timeline"></div>
			<!-- <div class="if-exists" id=nightTime><span class="time-column" /><span class="timeframe" id="nightColor">Nighttime</span></div>
			<div class="if-exists" id=nightEnd><span class="time-column time-text" id=nightEnd>04:00</span><span class="time" id="astroColor">Astronomical Dawn</span></div>
			<div class="if-exists" id=astroTime><span class="time-column" /><span class="timeframe" id="astroColor">Astron. Twilight</span></div>
			<div class="if-exists" id=nauticalDawn><span class="time-column time-text" id=nauticalDawn>04:00</span><span class="time" id="blueColor">Nautical Dawn</span></div>
			<div class="if-exists" id=blueTime><span class="time-column" /><span class="timeframe" id="blueColor">Blue Hour</span></div>
			<div class="if-exists" id=dawn><span class="time-column time-text" id=dawn>04:30</span><span class="time" id="goldenColor">Civil Dawn</span></div>
			<div class="if-exists" id=goldenTime><span class="time-column" /><span class="timeframe" id="goldenColor">Golden Hour</span></div>
			<div class="if-exists" id=sunrise><span class="time-column time-text" id=sunrise>05:00</span><span class="time-minor" id="goldenColor">Sunrise</span></div>
			<div class="if-exists" id=goldenHourEnd><span class="time-column time-text" id=goldenHourEnd>05:30</span><span class="time" id="dayColor">&nbsp;</span></div>
			<div class="if-exists" id=dayTime><span class="time-column" /><span class="timeframe" id="dayColor">Daytime</span></div>
			<div class="if-exists" id=dayTime><span class="time-column time-text" id=solarNoon>12:00</span><span class="time-minor" id="dayColor">Solar Noon</span></div>
			<div class="if-exists" id=solarNoonGolden><span class="time-column time-text" id=solarNoon>12:00</span><span class="time-minor" id="goldenColor">Solar Noon</span></div>
			<div class="if-exists" id=goldenHour><span class="time-column time-text" id=goldenHour>18:00</span><span class="time" id="goldenColor">&nbsp;</span></div>
			<div class="if-exists" id=goldenTime2><span class="time-column" /><span class="timeframe" id="goldenColor">Golden Hour</span></div>
			<div class="if-exists" id=sunset><span class="time-column time-text" id=sunset>18:30</span><span class="time-minor" id="goldenColor">Sunset</span></div>
			<div class="if-exists" id=dusk><span class="time-column time-text" id=dusk>19:00</span><span class="time" id="blueColor">Civil Dusk</span></div>
			<div class="if-exists" id=blueTime2><span class="time-column" /><span class="timeframe" id="blueColor">Blue Hour</span></div>
			<div class="if-exists" id=nauticalDusk><span class="time-column time-text" id=nauticalDusk>19:30</span><span class="time" id="astroColor">Nautical Dusk</span></div>
			<div class="if-exists" id=astroTime2><span class="time-column" /><span class="timeframe" id="astroColor">Astron. Twilight</span></div>
			<div class="if-exists" id=night><span class="time-column time-text" id=night>19:30</span><span class="time" id="nightColor">Astronomical Dusk</span></div>
			<div class="if-exists" id=nightTime2><span class="time-column" /><span class="timeframe" id="nightColor">Nighttime</span></div> -->

			<div class="current">
				<div class="current-time" id=current_time>12:25</div>
				<span class="current-pos">Azimuth</span>
				<span class="current-pos">Altitude</span><br />
				<span class="current-pos" id=azimuth>0</span>
				<span class="current-pos" id=altitude>0</span>

				<svg class="sun-path">
					<path id=sun_path />
					<path id=horizon d="M 0 50 H 200" />
					<circle class=sun-circle id=sun cx="50" cy="50" r="4"/>
				</svg>
			</div>

			<div class="footnote">
				windy-plugin-sun-position v. 0.2.1 by Jochen Jacobs (@jacobsjo) <br />
				calculations by SunCalc
			</div>
		</div>
	</div>

	<script>
		import picker from '@windy/picker'
		import utils from '@windy/utils'
		import store from '@windy/store'
		import map from '@windy/map'
		import pluginDataLoader from '@windy/pluginDataLoader'

		const options = {
			key: 'nMvpXdWHi4CcsJ6N0ewIYEcU0VE9ONMX',
			plugin: 'windy-plugin-sun-position'
		}

		const load = pluginDataLoader( options )
		const lineLength = 80

		const sunTimesConfig = {
			"nightEnd": {name: "Astronomical Dawn", starts:"Astronomical Twilight", new_class:"astroColor"},
			"nauticalDawn": {name: "Nautical Dawn", starts:"Blue Hour", new_class:"blueColor"},
			"dawn": {name: "Civil Dawn", starts:"Golden Hour", new_class:"goldenColor"},
			"sunrise": {name: "Sunrise", class: "minor"},
			"goldenHourEnd": {starts:"Daytime", new_class:"dayColor"},
			"solarNoon": {name: "Solar Noon", class: "minor"},
			"goldenHour": {starts: "Golden Hour", new_class:"goldenColor"},
			"sunset": {name: "Sunset", class: "minor"},
			"dusk": {name: "Civil Dusk", starts: "Blue Hour", new_class:"blueColor"},
			"nauticalDusk": {name: "Nautical Dusk", starts: "Astronomical Twilight", new_class: "astroColor"},
			"night": {name: "Astronomical Dusk", starts: "Nighttime", new_class: "nightColor"}
		}

		const firstTimeConfig = [
			{altitude: -90, starts: "Nighttime", new_class:"nightColor"},
			{altitude: -18, starts: "Astronomical Twilight", new_class:"astroColor"},
			{altitude: -12, starts: "Blue Hour", new_class:"blueColor"},
			{altitude: -6, starts: "Golden Hour", new_class:"goldenColor"},
			{altitude: 6, starts: "Daytime", new_class:"dayColor"}
		]

		var isOpen = false;

		this.onopen = () => {
			if (isOpen) return;
			isOpen = true;

			if (!d3.select(".picker").empty() && d3.select(".picker").style("display") != "none") {
				onPickerOpened()
				movedPickerRedraw()
			};

		}

		this.onclose = () => {
			isOpen = false;
			d3.select(".picker").select("svg").remove()
		}

		const readValues = latLon => {
			pickerOpen = true
			redraw()
		}

		var svg
		var sunLine
		var sunriseLine
		var sunsetLine

		var timeOffset = 0
		var useUTC = false

		// when the picker is opended, create svg to attach to picker and add lines
		const onPickerOpened = () => {

			d3.select(".picker").select("svg").remove() // just to be save that there will never be multiple svg's attached to the .picker

			var p = d3.select(".picker")
			svg = p.append("svg")
				.attr("class", "windy-plugin-sun-position sun-position-dial")
				.attr("viewBox", "0 0 199 199")
			sunriseLine = svg.append("line").attr("class", "dial-line dial-line-sunrise")
				.attr("x1", 100).attr("y1", 100).attr("x2", 100).attr("y2", 100).on("click", function(d) {setTime("sunrise")})
			sunsetLine = svg.append("line").attr("class", "dial-line dial-line-sunset")
				.attr("x1", 100).attr("y1", 100).attr("x2", 100).attr("y2", 100).on("click", function(d) {setTime("sunset")})
			sunLine = svg.append("line").attr("class", "dial-line dial-line-sun")
				.attr("x1", 100).attr("y1", 100).attr("x2", 100).attr("y2", 100)

			//set hover classes
			d3.selectAll(".dial-line")
				.on("mouseover", function(d) {
				  d3.select(this).attr("id", "hover");
				})
				.on("mouseout", function(d) {
				  d3.select(this).attr("id", "");
				});

			// show timeline in sidebar (and hide "open picker" message)
			d3.select(".sun-times").attr("id", "")
			d3.select(".open-picker").attr("id", "hide")
		}

		// when the picker moves, redraw and look up timezone, if timezone is different redraw again with correct time
		const movedPickerRedraw = () => {
			redraw()

			if (store.get('zuluMode')){
				return;
			}

			let { lat, lon, values, overlay } = picker.getParams()
			const dataOptions = {
				model: 'gfs',
				lat: lat,
				lon: lon
			}

			load('forecast', dataOptions).then( ({data}) => {
				if (timeOffset != data.celestial.TZoffsetMin){
					timeOffset = data.celestial.TZoffsetMin
					redraw()
				}
			})
		}

		// update drawing and timeline
		const redraw = () => {

			if (store.get('zuluMode')){
				timeOffset = 0;
			}

			// get picker position
			let { lat, lon, values, overlay } = picker.getParams()

			// get timestamp
			var time = store.get('timestamp')

			// get sun directions
			var times = SunCalc.getTimes(time, lat, lon)
			var sunPos = SunCalc.getPosition(time, lat, lon)
			var sunrisePos = SunCalc.getPosition(times.sunrise, lat, lon)
			var sunsetPos = SunCalc.getPosition(times.sunset, lat, lon)

			var sunLineLength
			var sunLineOpacity

			//==== draw dial on picker ====

			if (sunPos.altitude > 0) { // if sun is above horizon, calculate lenght of sun line from altitude
				sunLineLength = Math.cos(sunPos.altitude) * lineLength
				sunLineOpacity = 1
			} else if (sunPos.altitude > -0.1) {  //if sun is less than 6 degrees below horizon, calculate opacity from altitude
				sunLineLength = lineLength
				sunLineOpacity = 1 + 10.0 * sunPos.altitude
			} else { // if sun is further than 6 degrees below horizion, hide sun line
				sunLineLength = lineLength
				sunLineOpacity = 0
			}

			// set sun line
			sunLine.attr("x2", 100 - Math.sin(sunPos.azimuth) * sunLineLength).attr("y2", 100 + Math.cos(sunPos.azimuth) * sunLineLength).attr("stroke-opacity", sunLineOpacity)

			// if there is a sunrise, draw sunrise and sunset lines
			if (isNaN(sunrisePos.azimuth)){
				// hide lines
				sunriseLine.attr("x2", 100).attr("y2", 100)
				sunsetLine.attr("x2", 100).attr("y2", 100)
			} else {
				// draw lines
				sunriseLine.attr("x2", 100 - Math.sin(sunrisePos.azimuth) * lineLength).attr("y2", 100 + Math.cos(sunrisePos.azimuth) * lineLength)
				sunsetLine.attr("x2", 100 - Math.sin(sunsetPos.azimuth) * lineLength).attr("y2", 100 + Math.cos(sunsetPos.azimuth) * lineLength)
			}

			//==== draw timeline ====

			var minAltitude = SunCalc.getPosition(times.nadir, lat, lon).altitude * 180 / Math.PI
			var maxAltitude = SunCalc.getPosition(times.solarNoon, lat, lon).altitude * 180 / Math.PI


			// create timeline storage
			var timeline = []

			// calculate first timeframe
			var firstConfig
			for (i in firstTimeConfig){
				if (firstTimeConfig[i].altitude > minAltitude){
					break;
				}
				firstConfig = firstTimeConfig[i]
			}

			//add first time to timeline (time 0 puts it at front during sorting and hides element from being rendered individually)
			timeline.push({time: 0, name: undefined, starts: firstConfig.starts, color_class: undefined, new_class: firstConfig.new_class})

			for (var time in times){
				if (sunTimesConfig[time] && !isNaN(times[time])){
					timeline.push({time: times[time], name: sunTimesConfig[time].name, starts: sunTimesConfig[time].starts, class: sunTimesConfig[time].class, new_class: sunTimesConfig[time].new_class})
				}
			}

			// future: add moon times and eclipse time to timeline


			// sort timeline
			timeline.sort((a,b) => (a.time > b.time) ? 1 : -1)

			// create entries in sidebar timeline
			var tlo = d3.select(".sun-times .timeline").html("") // get html timeline object
			var current_class = ""
			for (var i in timeline){
				if (timeline[i].new_class){
					current_class = timeline[i].new_class
				}

				if (timeline[i].time > 0){ //hide first element used to set first timeframe
					var tle = tlo.append("div").attr("class", "timeline-entry timestamp " + (timeline[i].class ? timeline[i].class + " " : "") + current_class) // add timeline entry
					tle.append("span").attr("class", "time-column").html(time_format(timeline[i].time)) // add time column
					tle.append("span").attr("class", "name-column").html(timeline[i].name)
				}

				if (timeline[i].starts){
					var tle = tlo.append("div").attr("class", "timeline-entry timeframe " + current_class) // add timeline entry
					tle.append("span").attr("class", "time-column") // add time column
					tle.append("span").attr("class", "name-column").html(timeline[i].starts)
				}
			}



			//===== draw altitude diagram =====
			/*
			var data = []

			var t = new Date(time).setUTCHours(0,-timeOffset,0,0)
			var steps = 100
			var stepSize = 24.0*60*60*1000 / steps
			//get altitude for each time
			for (var i = 0 ; i<=steps; i++){
				var alt = -SunCalc.getPosition(t + stepSize*i, lat, lon).altitude;
				data[i] = {x: 1.0*i/steps, y: alt}
			}

			// set line
	    var line = d3.line()
	                 .x(function(d) { return d['x']*200 })
	                 .y(function(d) { return (d['y']+Math.PI/2) * 100/Math.PI });

			// set d attirubte of line
	    d3.select('#sun_path').attr('d', line(data));

			// set current sun position (yellow circle)
			d3.select('#sun')
			.attr('cx', (time - t)*200.0/(24.0*60*60*1000) % 200)
			.attr('cy', (-sunPos.altitude+Math.PI/2) * 100/Math.PI )*/

		}


		function time_format(d) {
			if (isNaN(d)){
				return "--:--" + (store.get('zuluMode') ? "Z" : "")
			}

			var d_local = new Date(d.getTime() + timeOffset * 60 * 1000)

	    var hours = format_two_digits(d_local.getUTCHours());
	    var minutes = format_two_digits(d_local.getUTCMinutes());
	    return hours + ":" + minutes + (store.get('zuluMode') ? "Z" : "");
		}

		function format_two_digits(n) {
	    return n < 10 ? '0' + n : n;
		}

		const setTime = timeString => {
			console.log('setting time to', timeString)
			let { lat, lon, values, overlay } = picker.getParams()
			var time = store.get('timestamp')
			var times = SunCalc.getTimes(time, lat, lon)

			store.set('timestamp', times[timeString].getTime())
		}

		// picker has been opened at latLon coords
		picker.on('pickerOpened', latLon => {
			if (!isOpen) return;
			onPickerOpened()

			movedPickerRedraw()
		} )

		// picker was dragged by user to latLon coords
		picker.on('pickerMoved', latLon => {
			if (!isOpen) return;

			movedPickerRedraw()
		})

		// picker was closed
		picker.on('pickerClosed', () => {
			d3.select(".sun-times").attr("id", "hide")
			d3.select(".open-picker").attr("id", "")

			d3.select(".picker").select("svg").remove()
		})

		store.on('timestamp', ts => {redraw()})

	</script>
</plugin>
